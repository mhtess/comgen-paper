# Appendix C: Full model posteriors
```{r}
knitr::opts_chunk$set(fig.width=6, fig.height=5, fig.crop = F, fig.path='figs/',
                      echo=FALSE, warning=FALSE, cache=T, message=FALSE, sanitize = T)
```


```{r}
library(rwebppl)
library(xtable)
library(tidyverse)
library(forcats)
library(langcog)
library(data.table)
library(coda)
library(ggthemes)
library(ggrepel)
library(jsonlite)
theme_set(theme_few())
estimate_mode <- function(s) {
  d <- density(s)
  return(d$x[which.max(d$y)])
}
hdi_upper<- function(s){
  m <- HPDinterval(mcmc(s))
  return(m["var1","upper"])
}
hdi_lower<- function(s){
  m <- HPDinterval(mcmc(s))
  return(m["var1","lower"])
}
project.path <- "../"
data.path <- "data/generics/endorsement/"
model.path <- "models/generics/results/"
options("scipen"=10) 
```

## Case Study 1: Generic language

```{r}
d.gen.endorse.catch <- read.csv(paste(project.path, "data/generics/endorsement/",
                    "truth-judgments_catch-trials.csv", sep = ""))

d.gen.endorse <- read.csv(paste(project.path, "data/generics/endorsement/",
                    "truth-judgments-n100.csv", sep = ""))


d.gen.endorse.summary <- left_join(
  d.gen.endorse, 
  d.gen.endorse.catch %>% select(workerid, pass)
  ) %>%
  filter(pass == 1) %>%
  rowwise() %>%
  mutate(response = ifelse(response == "agree-key", 1, 0),
         sentence = gsub('&quotechar', '', sentence),
         sentence = gsub('lyme', 'Lyme', sentence)) %>%
  group_by(sentence) %>%
  multi_boot_standard(column = "response") %>%
  ungroup() %>%
  mutate(sentence = factor(sentence, levels = sentence[order(mean)]))

d.gen.endorse.bayes <- left_join(
  d.gen.endorse, 
  d.gen.endorse.catch %>% select(workerid, pass)
  ) %>%
  filter(pass == 1) %>%
  rowwise() %>%
  mutate(response = ifelse(response == "agree-key", 1, 0),
         sentence = gsub('&quotechar', '', sentence),
         sentence = gsub('lyme', 'Lyme', sentence)) %>%
  group_by(sentence) %>%
  summarize(k = sum(response), n = n()) %>%
  ungroup() %>%
  mutate(a = 1 + k,
         b = 1 + n - k,
         low  = qbeta(.025, a, b),
         high = qbeta(.975, a, b),
         MAP_h = (a-1)/(a+b-2),
         mean = a / (a + b)) %>% 
  ungroup() %>%
  mutate(sentence = factor(sentence, levels = sentence[order(MAP_h)]))
```

### Uncertain threshold RSA 

```{r gen-loadModels}
n_chains <- 3
n_samples <- 100000
burn <- n_samples / 2
lg <- 20

model_prefix <- "results-generics-jointModel-S1-smntcs_"

# m.samp <- data.frame()
# m.samp.fixed <- data.frame()
# for (i in seq(1, n_chains)){
#   mi.gen <- fread(paste(project.path,  "models/generics/results/", model_prefix, "generic-",
#                     n_samples, "_burn", burn, "_lag", lg, "_chain", i, ".csv", sep = ""))
#   m.samp <- bind_rows(m.samp, mi.gen %>% mutate(chain = i))
#   
#   mi.fixed <- fread(paste(project.path,  "models/generics/results/", model_prefix,"some-",
#                     n_samples, "_burn", burn, "_lag", lg ,"_chain", i, ".csv", sep = ""))
#   m.samp.fixed <- bind_rows(m.samp.fixed, mi.fixed %>% mutate(chain = i))
#   
#   #print(i)
# }

load(file = paste(project.path,  "models/generics/results/", model_prefix, "generic-",
                    n_samples, "_burn", burn, "_lag", lg, "_",n_chains , "chains.RData", sep = ""))

load(file = paste(project.path,  "models/generics/results/", model_prefix, "some-",
                    n_samples, "_burn", burn, "_lag", lg, "_",n_chains , "chains.RData", sep = ""))

```


#### Speaker optimality parameter

```{r gen-speakeropt}
m.samp %>% 
  filter(type == "param") %>%
  ggplot(., aes(x = val, fill = factor(chain)))+
  geom_histogram(position = position_dodge())+
  facet_wrap(~param + property, scales = 'free')
```

#### Posterior predictive distribution on target prevalence


```{r gen-prev-loadData}
d.prior <- read.csv(paste(project.path, data.path, 
                    "naturalGenerics-prior-trials-n57.csv", sep = ""))

full_sentences <- d.gen.endorse.bayes$sentence

#d.gen.endorse.bayes

d.prior.summary <- d.prior %>% 
  mutate(sentence = paste(Category," " ,Property, ".", sep = "")) %>%
  filter(sentence %in% full_sentences) %>%
  mutate(prevalence = prevalence / 100) %>%
  group_by(Category, Property) %>%
  multi_boot_standard(column = "prevalence")
```



```{r gen-prev-forward}
#Forward sample Target Prevalence from posterior on parameters
m.samp.prev.params <- m.samp %>%
    filter(type == "targetPrevalence") %>%
    mutate(parameter = paste(param, property, category, sep = "_")) %>%
    select(-param, -property, -category, -chain, -type) %>%
    #mutate(item = paste(parameter, property, sep = "_")) %>%
    group_by(parameter) %>%
    mutate(iteration = ave(parameter==parameter, parameter, FUN=cumsum)) %>%
    ungroup() %>%
    separate(parameter, into = c("parameter", "property", "category"), sep= "_")
  
m.samp.prevalence <- m.samp.prev.params %>%
    group_by(category, property, iteration) %>%
    spread(parameter, val) %>%
    rowwise() %>%
    mutate(
      a = mean*sampleSize,
      b = (1-mean)*sampleSize,
      prevalence = rbeta(n = 1, shape1 = a, shape2 = b)
      ) %>%
    ungroup()
```

#### Target prevalence

##### Full distributions

```{r gen-prev-dists, fig.width = 8, fig.height = 6}
bind_rows(
  d.prior %>% 
  mutate(sentence = paste(Category," " ,Property, ".", sep = "")) %>%
  filter(sentence %in% full_sentences) %>%
  mutate(prevalence = prevalence / 100,
         src = 'data') %>% 
    select(-workerid, -trial_type),
  m.samp.prevalence %>% 
    select(property, category, prevalence) %>%
    rename(Category = category, Property = property) %>%
    mutate(src = 'model') 
  ) %>%
ggplot(. , aes( x = prevalence, color = src))+
  geom_density(size = 1, aes( y = ..scaled.. ))+
  #geom_histogram(aes(y=(..count..)/tapply(..count..,..PANEL..,sum)[..PANEL..]),
   #              position = position_dodge())+
  facet_wrap(~Property + Category)+
  scale_color_solarized()+
  scale_x_continuous(limits = c(-0.05,1.05), breaks = c(0, 0.5, 1)) +
  scale_y_continuous(limits = c(-0.01,1.01), breaks = c(0, 0.5, 1)) +
  theme(strip.text.y = element_text(angle = 0))
```

##### Means and CIs


```{r gen-prev-means}
# joint model inferred prevalence 
m.samp.targetPrev <- m.samp.prevalence %>% 
  group_by(category, property) %>%
  summarize(MAP = estimate_mode(prevalence),
          cred_upper = hdi_upper(prevalence),
          cred_lower = hdi_lower(prevalence),
          prevMean = mean(prevalence)) %>%
  ungroup() %>% rename(Category = category, Property = property)
  
left_join(d.prior.summary, 
          m.samp.targetPrev) %>%
  ggplot(., aes(x = prevMean, xmin = cred_lower, xmax = cred_upper,
                y = mean, ymin = ci_lower, ymax = ci_upper))+
  geom_point()+geom_errorbar(alpha = 0.3)+ geom_errorbarh(alpha = 0.3)+
  scale_x_continuous(limits = c(0, 1))+
  scale_y_continuous(limits = c(0, 1))+
  geom_abline(intercept = 0, slope = 1, lty = 3, alpha = 0.3)+
  coord_fixed()
```

##### Does posterior on target prevalence predict generic endorsement?

```{r gen-prevalence-vs-endorsement}
left_join(
  d.gen.endorse.bayes,
  m.samp.prevalence %>% 
  group_by(category, property) %>%
  summarize(MAP = estimate_mode(prevalence),
          cred_upper = hdi_upper(prevalence),
          cred_lower = hdi_lower(prevalence),
          prevMean = mean(prevalence)) %>%
  ungroup() %>% rename(Category = category, Property = property) %>%
  mutate(sentence = paste(Category, " ", Property, ".", sep = ""))
) %>%
  ggplot(., aes(x = prevMean, xmin = cred_lower, xmax = cred_upper,
                y = MAP_h, ymin = low, ymax = high))+
  geom_point()+geom_errorbar(alpha = 0.3)+ geom_errorbarh(alpha = 0.3)+
  scale_x_continuous(limits = c(0, 1))+
  scale_y_continuous(limits = c(0, 1))+
  geom_abline(intercept = 0, slope = 1, lty = 3, alpha = 0.3)+
  coord_fixed()
```



#### Posterior predictive distribution on prevalance priors


```{r gen-prevprior-forward}
#Forward sample from posterior on parameters
m.samp.prior.params <- m.samp %>%
    filter(type == "prior") %>%
    mutate(parameter = paste(param, category, sep = "_")) %>%
    select(-param, -category, -chain, -type) %>%
    mutate(item = paste(parameter, property, sep = "_")) %>%
    group_by(item) %>%
    mutate(iteration = ave(item==item, item, FUN=cumsum)) %>%
    ungroup() %>%
    select(-item)
  
  m.samp.prevalence.prior <- m.samp.prior.params %>%
    group_by(parameter, property, iteration) %>%
    spread(parameter, val) %>%
    rowwise() %>%
    mutate(isPresent = rbinom(1, 1, prob = mixture_NA),
       prevalence = ifelse(isPresent == 1, 
                           rbeta(n = 1, 
                                 shape1 = stableFreq_mean* stableFreq_sampleSize,
                                 shape2 = (1-stableFreq_mean)*stableFreq_sampleSize),
                           rbeta(n = 1,
                                 shape1 = 1,
                                 shape2 = 100))) %>%
    ungroup() %>%
    select(property, prevalence)
```

##### Marginal distributions on prevalence

```{r gen-prevprior-marginals, fig.width = 8, fig.height = 5}
bind_rows(
  d.prior %>% 
  mutate(prevalence = prevalence / 100,
         src = 'data') %>% 
  select(-workerid, -trial_type, -Category),
  m.samp.prevalence.prior %>% 
    rename(Property = property) %>%
    mutate(src = 'model') 
  ) %>%
ggplot(. , aes( x = prevalence, color = src))+
  geom_density(size = 1, aes( y = ..scaled.. ))+
  facet_wrap( ~ Property, nrow = 3)+
  scale_color_solarized()+
  scale_x_continuous(limits = c(0,1), breaks = c(0, 0.5, 1)) +
  scale_y_continuous(limits = c(0,1), breaks = c(0, 0.5, 1)) +
  theme(strip.text.y = element_text(angle = 0))
```


##### Cumulative Density Functions


```{r gen-prevprior-cdf, fig.width = 8, fig.height = 5}
bind_rows(
  d.prior %>% 
  mutate(prevalence = prevalence / 100,
         src = 'data') %>% 
  select(-workerid, -trial_type, -Category),
  m.samp.prevalence.prior %>% 
    rename(Property = property) %>%
    mutate(src = 'model') 
  ) %>% ggplot(., aes( x = prevalence, color = src))+
    stat_ecdf()+
    facet_wrap(~Property, nrow = 3)+
    scale_color_solarized()+
    scale_x_continuous(limits = c(-0.01,1.01), breaks = c(0, 0.5, 1)) +
    scale_y_continuous(limits = c(-0.01,1.01), breaks = c(0, 0.5, 1)) +
    theme(strip.text.y = element_text(angle = 0))
```





### Fixed threshold model 

#### Speaker optimality parameter

```{r gen-fixed-speakeropt}
m.samp.fixed %>% 
  filter(type == "param") %>%
  ggplot(., aes(x = val, fill = factor(chain)))+
  geom_histogram(position = position_dodge())+
  facet_wrap(~param + property, scales = 'free')
```

#### Posterior predictive distribution on target prevalence

```{r gen-fixed-prev-forward}
#Forward sample Target Prevalence from posterior on parameters
m.samp.fixed.prev.params <- m.samp.fixed %>%
    filter(type == "targetPrevalence") %>%
    mutate(parameter = paste(param, property, category, sep = "_")) %>%
    select(-param, -property, -category, -chain, -type) %>%
    #mutate(item = paste(parameter, property, sep = "_")) %>%
    group_by(parameter) %>%
    mutate(iteration = ave(parameter==parameter, parameter, FUN=cumsum)) %>%
    ungroup() %>%
    separate(parameter, into = c("parameter", "property", "category"), sep= "_")
  
m.samp.fixed.prevalence <- m.samp.fixed.prev.params %>%
    group_by(category, property, iteration) %>%
    spread(parameter, val) %>%
    rowwise() %>%
    mutate(
      a = mean*sampleSize,
      b = (1-mean)*sampleSize,
      prevalence = rbeta(n = 1, shape1 = a, shape2 = b)
      ) %>%
    ungroup()
```

#### Target prevalence

##### Full distributions

```{r gen-fixed-prev-dists, fig.width = 8, fig.height = 6}
bind_rows(
  d.prior %>% 
  mutate(sentence = paste(Category," " ,Property, ".", sep = "")) %>%
  filter(sentence %in% full_sentences) %>%
  mutate(prevalence = prevalence / 100,
         src = 'data') %>% 
    select(-workerid, -trial_type),
  m.samp.fixed.prevalence %>% 
    select(property, category, prevalence) %>%
    rename(Category = category, Property = property) %>%
    mutate(src = 'model') 
  ) %>%
ggplot(. , aes( x = prevalence, color = src))+
  geom_density(size = 1, aes( y = ..scaled.. ))+
  #geom_histogram(aes(y=(..count..)/tapply(..count..,..PANEL..,sum)[..PANEL..]),
   #              position = position_dodge())+
  facet_wrap(~Property + Category)+
  scale_color_solarized()+
  scale_x_continuous(limits = c(-0.05,1.05), breaks = c(0, 0.5, 1)) +
  scale_y_continuous(limits = c(-0.01,1.01), breaks = c(0, 0.5, 1)) +
  theme(strip.text.y = element_text(angle = 0))
```

##### Means and CIs


```{r gen-fixed-prev-means}
# joint model inferred prevalence 
m.samp.fixed.targetPrev <- m.samp.fixed.prevalence %>% 
  group_by(category, property) %>%
  summarize(MAP = estimate_mode(prevalence),
          cred_upper = hdi_upper(prevalence),
          cred_lower = hdi_lower(prevalence),
          prevMean = mean(prevalence)) %>%
  ungroup() %>% rename(Category = category, Property = property)
  
left_join(d.prior.summary, 
          m.samp.fixed.targetPrev) %>%
  ggplot(., aes(x = prevMean, xmin = cred_lower, xmax = cred_upper,
                y = mean, ymin = ci_lower, ymax = ci_upper))+
  geom_point()+geom_errorbar(alpha = 0.3)+ geom_errorbarh(alpha = 0.3)+
  scale_x_continuous(limits = c(0, 1))+
  scale_y_continuous(limits = c(0, 1))+
  geom_abline(intercept = 0, slope = 1, lty = 3, alpha = 0.3)+
  coord_fixed()
```

##### Does posterior on target prevalence predict generic endorsement?

```{r gen-fixed-prevalence-vs-endorsement}
left_join(
  d.gen.endorse.bayes,
  m.samp.fixed.prevalence %>% 
  group_by(category, property) %>%
  summarize(MAP = estimate_mode(prevalence),
          cred_upper = hdi_upper(prevalence),
          cred_lower = hdi_lower(prevalence),
          prevMean = mean(prevalence)) %>%
  ungroup() %>% rename(Category = category, Property = property) %>%
  mutate(sentence = paste(Category, " ", Property, ".", sep = ""))
) %>%
  ggplot(., aes(x = prevMean, xmin = cred_lower, xmax = cred_upper,
                y = MAP_h, ymin = low, ymax = high))+
  geom_point()+geom_errorbar(alpha = 0.3)+ geom_errorbarh(alpha = 0.3)+
  scale_x_continuous(limits = c(0, 1))+
  scale_y_continuous(limits = c(0, 1))+
  geom_abline(intercept = 0, slope = 1, lty = 3, alpha = 0.3)+
  coord_fixed()
```



#### Posterior predictive distribution on prevalance priors


```{r gen-fixed-prevprior-forward}
#Forward sample from posterior on parameters
m.samp.fixed.prior.params <- m.samp.fixed %>%
    filter(type == "prior") %>%
    mutate(parameter = paste(param, category, sep = "_")) %>%
    select(-param, -category, -chain, -type) %>%
    mutate(item = paste(parameter, property, sep = "_")) %>%
    group_by(item) %>%
    mutate(iteration = ave(item==item, item, FUN=cumsum)) %>%
    ungroup() %>%
    select(-item)
  
  m.samp.fixed.prevalence.prior <- m.samp.fixed.prior.params %>%
    group_by(parameter, property, iteration) %>%
    spread(parameter, val) %>%
    rowwise() %>%
    mutate(isPresent = rbinom(1, 1, prob = mixture_NA),
       prevalence = ifelse(isPresent == 1, 
                           rbeta(n = 1, 
                                 shape1 = stableFreq_mean* stableFreq_sampleSize,
                                 shape2 = (1-stableFreq_mean)*stableFreq_sampleSize),
                           rbeta(n = 1,
                                 shape1 = 1,
                                 shape2 = 100))) %>%
    ungroup() %>%
    select(property, prevalence)
```

##### Marginal distributions on prevalence

```{r gen-fixed-prevprior-marginals, fig.width = 8, fig.height = 5}
bind_rows(
  d.prior %>% 
  mutate(prevalence = prevalence / 100,
         src = 'data') %>% 
  select(-workerid, -trial_type, -Category),
  m.samp.fixed.prevalence.prior %>% 
    rename(Property = property) %>%
    mutate(src = 'model') 
  ) %>%
ggplot(. , aes( x = prevalence, color = src))+
  geom_density(size = 1, aes( y = ..scaled.. ))+
  facet_wrap( ~ Property, nrow = 3)+
  scale_color_solarized()+
  scale_x_continuous(limits = c(0,1), breaks = c(0, 0.5, 1)) +
  scale_y_continuous(limits = c(0,1), breaks = c(0, 0.5, 1)) +
  theme(strip.text.y = element_text(angle = 0))
```


##### Cumulative Density Functions


```{r gen-fixed-prevprior-cdf, fig.width = 8, fig.height = 5}
bind_rows(
  d.prior %>% 
  mutate(prevalence = prevalence / 100,
         src = 'data') %>% 
  select(-workerid, -trial_type, -Category),
  m.samp.fixed.prevalence.prior %>% 
    rename(Property = property) %>%
    mutate(src = 'model') 
  ) %>% ggplot(., aes( x = prevalence, color = src))+
    stat_ecdf()+
    facet_wrap(~Property, nrow = 3)+
    scale_color_solarized()+
    scale_x_continuous(limits = c(-0.01,1.01), breaks = c(0, 0.5, 1)) +
    scale_y_continuous(limits = c(-0.01,1.01), breaks = c(0, 0.5, 1)) +
    theme(strip.text.y = element_text(angle = 0))
```



